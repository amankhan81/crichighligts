<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CricketScan AI - Pro</title>
    
    <!-- 1. Fonts (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        slate: { 850: '#151e2e', 950: '#020617' }
                    }
                }
            }
        }
    </script>
    
    <!-- 3. React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 4. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 5. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { background-color: #020617; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 20px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: #34d399; margin-top: -5px; box-shadow: 0 0 10px rgba(52, 211, 153, 0.5);
            cursor: pointer; transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        
        @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-enter { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-slate-200 antialiased selection:bg-emerald-500/30 selection:text-emerald-200">
    <div id="root" class="h-screen w-screen flex flex-col"></div>

    <script type="text/babel">
        const React = window.React;
        const ReactDOM = window.ReactDOM;

        if (!React || !ReactDOM) {
            throw new Error("React/ReactDOM not found. Check internet connection or offline setup.");
        }

        const { useState, useRef, useEffect } = React;
        
        // --- ICON COMPONENT ---
        const Icon = ({ name, size = 24, className }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!window.lucide || !ref.current) return;
                ref.current.innerHTML = '';
                const pascalName = name.split('-').map((part) => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconData = window.lucide.icons[pascalName];
                if (iconData) {
                    const svgElement = window.lucide.createElement(iconData);
                    svgElement.setAttribute('width', size);
                    svgElement.setAttribute('height', size);
                    if (className) {
                        const existingClass = svgElement.getAttribute('class') || '';
                        svgElement.setAttribute('class', `${existingClass} ${className}`);
                    }
                    ref.current.appendChild(svgElement);
                }
            }, [name, size, className]);
            return <span ref={ref} className="inline-flex items-center justify-center"></span>;
        };

        const getColorDistance = (c1, c2) => Math.sqrt(Math.pow(c1.r - c2.r, 2) + Math.pow(c1.g - c2.g, 2) + Math.pow(c1.b - c2.b, 2));

        const getAverageColor = (imageData) => {
            let r = 0, g = 0, b = 0;
            const totalPixels = imageData.width * imageData.height;
            for (let i = 0; i < imageData.data.length; i += 4) {
                r += imageData.data[i];
                g += imageData.data[i + 1];
                b += imageData.data[i + 2];
            }
            return {
                r: Math.round(r / totalPixels),
                g: Math.round(g / totalPixels),
                b: Math.round(b / totalPixels),
            };
        };

        const rgbToHex = ({ r, g, b }) => "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);

        const App = () => {
            const [videoSrc, setVideoSrc] = useState(null);
            const [triggers, setTriggers] = useState([]);
            const [highlights, setHighlights] = useState([]);
            const [isScanning, setIsScanning] = useState(false);
            const [isExporting, setIsExporting] = useState(false);
            const [progress, setProgress] = useState(0); 
            const [currentTime, setCurrentTime] = useState(0);
            const [duration, setDuration] = useState(0);
            const [isPlaying, setIsPlaying] = useState(false);
            
            const [preRoll, setPreRoll] = useState(5); 
            const [clipDuration, setClipDuration] = useState(10); 
            const [scanSpeed, setScanSpeed] = useState(5); 

            const [isDrawing, setIsDrawing] = useState(false);
            const [startPos, setStartPos] = useState(null);
            const [currentRect, setCurrentRect] = useState(null);
            const [showTriggerModal, setShowTriggerModal] = useState(false);
            const [tempTriggerColor, setTempTriggerColor] = useState(null);
            const [resetKey, setResetKey] = useState(0); 

            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const containerRef = useRef(null);
            const scanRequestRef = useRef(null);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                event.target.value = '';
                if (file) {
                    try {
                        const url = URL.createObjectURL(file);
                        setVideoSrc(url);
                        setHighlights([]);
                        setTriggers([]);
                        setProgress(0);
                        setIsPlaying(false);
                    } catch (err) {
                        alert("Error loading: " + err.message);
                    }
                }
            };

            const resetApp = () => {
                if (window.confirm("Start over? This will clear the current project.")) {
                    if (scanRequestRef.current) cancelAnimationFrame(scanRequestRef.current);
                    if (videoSrc) URL.revokeObjectURL(videoSrc);
                    setVideoSrc(null);
                    setTriggers([]);
                    setHighlights([]);
                    setProgress(0);
                    setCurrentTime(0);
                    setDuration(0);
                    setIsPlaying(false);
                    setIsScanning(false);
                    setIsExporting(false);
                    setResetKey(prev => prev + 1); 
                }
            };

            const deleteHighlight = (indexToDelete) => {
                setHighlights(prev => prev.filter((_, index) => index !== indexToDelete));
            };

            const handleTimeUpdate = () => {
                if (videoRef.current && !isScanning && !isExporting) {
                    setCurrentTime(videoRef.current.currentTime);
                }
            };

            const handleLoadedMetadata = () => {
                if (videoRef.current) setDuration(videoRef.current.duration);
            };

            const togglePlay = () => {
                if (videoRef.current) {
                    if (isPlaying) videoRef.current.pause();
                    else videoRef.current.play();
                    setIsPlaying(!isPlaying);
                }
            };

            const startDrawing = (e) => {
                if (!videoSrc || isScanning || isExporting) return;
                const rect = containerRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                setIsDrawing(true);
                setStartPos({ x, y });
                setCurrentRect({ x, y, w: 0, h: 0 });
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const rect = containerRef.current.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                setCurrentRect({
                    x: Math.min(x, startPos.x),
                    y: Math.min(y, startPos.y),
                    w: Math.abs(x - startPos.x),
                    h: Math.abs(y - startPos.y)
                });
            };

            const endDrawing = () => {
                if (!isDrawing) return;
                setIsDrawing(false);
                if (currentRect && currentRect.w > 10 && currentRect.h > 10) {
                    analyzeRegionForTrigger();
                } else {
                    setCurrentRect(null);
                }
            };

            const analyzeRegionForTrigger = () => {
                if (!videoRef.current || !canvasRef.current) return;
                const video = videoRef.current;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Simple scaling logic (Restored to previous working version)
                const displayRect = containerRef.current.getBoundingClientRect();
                const scaleX = video.videoWidth / displayRect.width;
                const scaleY = video.videoHeight / displayRect.height;

                const region = {
                    x: Math.floor(currentRect.x * scaleX),
                    y: Math.floor(currentRect.y * scaleY),
                    w: Math.floor(currentRect.w * scaleX),
                    h: Math.floor(currentRect.h * scaleY),
                };

                try {
                    const imageData = ctx.getImageData(region.x, region.y, region.w, region.h);
                    const avgColor = getAverageColor(imageData);
                    setTempTriggerColor(avgColor);
                    setShowTriggerModal(true);
                } catch (e) {
                    console.error("Image Data Error", e);
                    setCurrentRect(null);
                }
            };

            const saveTrigger = (label) => {
                const newTrigger = {
                    id: Date.now(),
                    rect: currentRect,
                    color: tempTriggerColor,
                    label: label,
                    tolerance: 50
                };
                setTriggers([...triggers, newTrigger]);
                setShowTriggerModal(false);
                setCurrentRect(null);
            };

            const stopScan = () => {
                if (scanRequestRef.current) cancelAnimationFrame(scanRequestRef.current);
                setIsScanning(false);
                if (videoRef.current) {
                    videoRef.current.pause();
                    videoRef.current.playbackRate = 1.0;
                    videoRef.current.muted = false;
                    videoRef.current.currentTime = 0;
                }
                setProgress(0);
            };

            const startScan = async () => {
                if (!videoRef.current || triggers.length === 0) return;
                setIsScanning(true);
                setHighlights([]);
                const video = videoRef.current;
                const canvas = document.createElement('canvas'); 
                const ctx = canvas.getContext('2d', { willReadFrequently: true });
                
                video.muted = true;
                try { await video.play(); } catch(err) { console.error("Autoplay failed", err); }
                video.playbackRate = scanSpeed;

                let lastCheckTime = -1;
                const checkInterval = 0.5;
                let lastMatchTime = -10; 

                const processLoop = () => {
                    if (video.paused || video.ended) {
                        stopScan();
                        return;
                    }

                    const vTime = video.currentTime;
                    setProgress((vTime / video.duration) * 100);

                    if (vTime - lastCheckTime >= checkInterval) {
                        lastCheckTime = vTime;
                        
                        if (vTime - lastMatchTime < 10) {
                            // Cooldown active
                        } else {
                            canvas.width = video.videoWidth;
                            canvas.height = video.videoHeight;
                            ctx.drawImage(video, 0, 0);

                            const displayRect = containerRef.current.getBoundingClientRect();
                            const scaleX = video.videoWidth / displayRect.width;
                            const scaleY = video.videoHeight / displayRect.height;

                            let matchedLabel = null;

                            for (let trigger of triggers) {
                                const region = {
                                    x: Math.floor(trigger.rect.x * scaleX),
                                    y: Math.floor(trigger.rect.y * scaleY),
                                    w: Math.floor(trigger.rect.w * scaleX),
                                    h: Math.floor(trigger.rect.h * scaleY),
                                };
                                if (region.w <= 0 || region.h <= 0) continue;

                                const imageData = ctx.getImageData(region.x, region.y, region.w, region.h);
                                const avgColor = getAverageColor(imageData);
                                const distance = getColorDistance(avgColor, trigger.color);

                                if (distance < trigger.tolerance) {
                                    matchedLabel = trigger.label;
                                    break;
                                }
                            }

                            if (matchedLabel) {
                                lastMatchTime = vTime; 
                                setHighlights(prev => {
                                    const last = prev[prev.length - 1];
                                    if (last && (vTime - last.eventTime < 10)) return prev;
                                    const adjustedStartTime = Math.max(0, vTime - preRoll);
                                    return [...prev, { 
                                        time: adjustedStartTime,
                                        eventTime: vTime, 
                                        type: matchedLabel, 
                                        thumbnail: canvas.toDataURL('image/jpeg', 0.5) 
                                    }];
                                });
                            }
                        }
                    }
                    scanRequestRef.current = requestAnimationFrame(processLoop);
                };
                scanRequestRef.current = requestAnimationFrame(processLoop);
            };

            const exportHighlights = async () => {
                if (highlights.length === 0 || !videoRef.current) return;
                setIsExporting(true);
                setProgress(0);
                
                const video = videoRef.current;
                const originalTime = video.currentTime;
                
                video.pause();
                video.playbackRate = 1.0; 
                video.muted = false;
                video.volume = 1.0;

                const exportCanvas = document.createElement('canvas');
                exportCanvas.width = video.videoWidth; 
                exportCanvas.height = video.videoHeight;
                const ctx = exportCanvas.getContext('2d', { alpha: false }); 

                let audioStream;
                if (video.captureStream) audioStream = video.captureStream();
                else if (video.mozCaptureStream) audioStream = video.mozCaptureStream();
                else {
                    alert("Browser does not support capturing video stream.");
                    setIsExporting(false);
                    return;
                }

                const audioTracks = audioStream.getAudioTracks();
                const canvasStream = exportCanvas.captureStream(60); 
                const finalStream = new MediaStream([
                    ...canvasStream.getVideoTracks(),
                    ...(audioTracks.length > 0 ? [audioTracks[0]] : [])
                ]);

                let mimeType = "video/webm;codecs=vp9,opus"; 
                if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = "video/webm;codecs=vp8,opus";
                if (!MediaRecorder.isTypeSupported(mimeType)) mimeType = "video/webm"; 

                const recorder = new MediaRecorder(finalStream, { 
                    mimeType, 
                    videoBitsPerSecond: 10000000 
                });

                const chunks = [];
                recorder.ondataavailable = (e) => {
                    if (e.data.size > 0) chunks.push(e.data);
                };

                recorder.start();
                recorder.pause();

                const sortedHighlights = [...highlights].sort((a, b) => a.time - b.time);
                let animationFrameId;
                let currentClipData = null;

                const renderLoop = () => {
                    if (!video.paused && !video.ended && currentClipData) {
                        ctx.drawImage(video, 0, 0, exportCanvas.width, exportCanvas.height);
                        
                        const t = video.currentTime;
                        const { start, end } = currentClipData;
                        const fadeDuration = 0.5;

                        // Modern Flash-to-White Transition
                        if (t >= start && t < start + fadeDuration) {
                            // Flash In (White -> Transparent)
                            const alpha = 1 - ((t - start) / fadeDuration);
                            ctx.fillStyle = `rgba(255,255,255,${Math.max(0, Math.min(1, alpha))})`;
                            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
                        } else if (t > end - fadeDuration && t <= end) {
                            // Flash Out (Transparent -> White)
                            const alpha = 1 - ((end - t) / fadeDuration);
                            ctx.fillStyle = `rgba(255,255,255,${Math.max(0, Math.min(1, alpha))})`;
                            ctx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
                        }
                    }
                    animationFrameId = requestAnimationFrame(renderLoop);
                };
                
                renderLoop();

                for (let i = 0; i < sortedHighlights.length; i++) {
                    const h = sortedHighlights[i];
                    const start = h.time;
                    const end = Math.min(video.duration, start + clipDuration);
                    
                    currentClipData = { start, end };

                    const preBuffer = 2.0; 
                    const seekTarget = Math.max(0, start - preBuffer);
                    const isRollingStart = start > preBuffer; 

                    video.currentTime = seekTarget;
                    
                    await new Promise(resolve => {
                        const onSeeked = () => {
                            video.removeEventListener('seeked', onSeeked);
                            setTimeout(resolve, 500); 
                        };
                        video.addEventListener('seeked', onSeeked);
                    });

                    try { await video.play(); } catch (e) { console.error("Playback failed", e); }

                    if (isRollingStart) {
                        await new Promise(resolve => {
                            const checkFrame = () => {
                                if (video.paused) { resolve(); return; }
                                if (video.currentTime >= start) { resolve(); } 
                                else { requestAnimationFrame(checkFrame); }
                            };
                            requestAnimationFrame(checkFrame);
                        });
                    }

                    if (recorder.state === "paused") recorder.resume();

                    await new Promise(resolve => {
                        const checkEndFrame = () => {
                            if (video.paused) { resolve(); return; }
                            if (video.currentTime >= end) { resolve(); } 
                            else { requestAnimationFrame(checkEndFrame); }
                        };
                        requestAnimationFrame(checkEndFrame);
                    });

                    video.pause();
                    recorder.pause();
                    setProgress(Math.round(((i + 1) / sortedHighlights.length) * 100));
                }

                cancelAnimationFrame(animationFrameId);
                recorder.stop();
                await new Promise(resolve => { recorder.onstop = resolve; });

                const blob = new Blob(chunks, { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cricket_highlights.webm`; 
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                setIsExporting(false);
                setProgress(0);
                video.currentTime = originalTime;
            };

            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const jumpToTime = (time) => {
                if (videoRef.current) {
                    videoRef.current.currentTime = time;
                    setIsPlaying(false);
                    videoRef.current.pause();
                }
            };

            return (
                <div className="flex flex-col h-screen overflow-hidden bg-slate-950 font-sans">
                    {/* --- HEADER --- */}
                    <header className="h-16 border-b border-slate-800 bg-slate-900/80 backdrop-blur-md flex items-center justify-between px-6 shrink-0 relative z-20 shadow-lg">
                        <div className="flex items-center gap-3">
                            <div className="w-9 h-9 bg-gradient-to-br from-emerald-500 to-cyan-500 rounded-xl flex items-center justify-center shadow-lg shadow-emerald-500/20">
                                <Icon name="video" size={20} className="text-white drop-shadow-sm" />
                            </div>
                            <div>
                                <h1 className="font-bold text-xl tracking-tight leading-none text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-cyan-400">CricketScan</h1>
                                <span className="text-[10px] font-semibold text-slate-500 uppercase tracking-widest">AI Highlights</span>
                            </div>
                        </div>
                        
                        {/* Styled Credits */}
                        <div className="absolute left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2 
                                        text-sm font-bold text-white tracking-wide 
                                        bg-slate-800/50 backdrop-blur-md 
                                        border border-white/10 px-4 py-1.5 rounded-full 
                                        shadow-[0_0_15px_rgba(16,185,129,0.3)] hidden md:block">
                            Created by: <span className="text-emerald-400">Amanullah Khan</span>
                        </div>

                        <div className="flex items-center gap-3">
                            {!videoSrc && (
                                <label key={resetKey} className="group flex items-center gap-2 px-5 py-2.5 bg-gradient-to-r from-indigo-600 to-blue-600 hover:from-indigo-500 hover:to-blue-500 rounded-full cursor-pointer transition shadow-lg shadow-blue-500/20 border border-white/10">
                                    <Icon name="upload" size={18} className="group-hover:scale-110 transition-transform" />
                                    <span className="text-sm font-semibold">Upload Video</span>
                                    <input type="file" accept="video/*" className="hidden" onChange={handleFileUpload} />
                                </label>
                            )}
                            {videoSrc && !isScanning && !isExporting && (
                                <>
                                    <button onClick={resetApp} className="flex items-center gap-2 px-4 py-2 text-slate-400 hover:text-white hover:bg-white/10 rounded-full transition text-xs font-medium" title="Reset Project">
                                        <Icon name="rotate-ccw" size={14} />
                                        Reset
                                    </button>
                                    <button onClick={startScan} disabled={triggers.length === 0} 
                                        className={`flex items-center gap-2 px-5 py-2.5 rounded-full font-semibold transition shadow-lg border border-white/10 ${triggers.length > 0 ? 'bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white shadow-emerald-500/20' : 'bg-slate-800 text-slate-500 cursor-not-allowed border-transparent'}`}>
                                        <Icon name="zap" size={18} className={triggers.length > 0 ? "fill-current" : ""} />
                                        Start Scan
                                    </button>
                                </>
                            )}
                            {(isScanning || isExporting) && (
                                <div className="flex items-center gap-4 px-5 py-2 bg-slate-900 border border-slate-700 rounded-full shadow-inner">
                                    <div className="flex items-center gap-3">
                                        <div className="relative flex h-3 w-3">
                                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                          <span className="relative inline-flex rounded-full h-3 w-3 bg-emerald-500"></span>
                                        </div>
                                        <span className="text-sm font-mono text-emerald-400">
                                            {isExporting ? 'Exporting...' : 'Scanning...'} {Math.round(progress)}%
                                        </span>
                                    </div>
                                    {isScanning && (
                                        <button onClick={stopScan} className="p-1 rounded-full hover:bg-white/10 text-red-400 hover:text-red-300 transition"><Icon name="x" size={14} /></button>
                                    )}
                                </div>
                            )}
                        </div>
                    </header>

                    {/* --- MAIN LAYOUT --- */}
                    <div className="flex flex-1 overflow-hidden">
                        
                        {/* LEFT: Video Stage */}
                        <div className="flex-1 bg-black/50 relative flex flex-col justify-center items-center overflow-hidden group">
                            <div className="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900/50 to-slate-950 -z-10"></div>
                            
                            {!videoSrc ? (
                                <div className="text-center p-12 border-2 border-dashed border-slate-700/50 rounded-3xl bg-slate-900/30 backdrop-blur-sm max-w-md mx-6">
                                    <div className="w-20 h-20 bg-slate-800/50 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-500">
                                        <Icon name="film" size={40} />
                                    </div>
                                    <h3 className="text-xl font-semibold text-slate-200 mb-2">No Video Selected</h3>
                                    <p className="text-slate-500">Upload a match recording (MP4/WebM) to start detecting highlights.</p>
                                </div>
                            ) : (
                                <>
                                    <div ref={containerRef} className="relative shadow-2xl shadow-black/80 w-full max-w-6xl aspect-video bg-black rounded-lg overflow-hidden border border-slate-800"
                                        onMouseDown={startDrawing} onMouseMove={draw} onMouseUp={endDrawing}
                                        style={{ cursor: isDrawing ? 'crosshair' : 'default' }}>
                                        <video ref={videoRef} src={videoSrc} className="w-full h-full object-contain" 
                                            onTimeUpdate={handleTimeUpdate} onLoadedMetadata={handleLoadedMetadata} crossOrigin="anonymous" playsInline 
                                        />
                                        <canvas ref={canvasRef} className="hidden" />
                                        
                                        {/* Drawing Box */}
                                        {currentRect && (
                                            <div className="absolute border-2 border-emerald-400 bg-emerald-400/20 backdrop-blur-[1px] shadow-[0_0_15px_rgba(52,211,153,0.3)]"
                                                style={{ left: currentRect.x, top: currentRect.y, width: currentRect.w, height: currentRect.h }} />
                                        )}
                                        
                                        {/* Trigger Overlays */}
                                        {triggers.map(t => (
                                            <div key={t.id} className="absolute border-2 border-yellow-400/60 bg-yellow-400/5 hover:bg-yellow-400/20 transition-colors"
                                                style={{ left: t.rect.x, top: t.rect.y, width: t.rect.w, height: t.rect.h }}>
                                                <span className="absolute -top-7 left-0 bg-yellow-400 text-black text-[10px] font-bold px-2 py-0.5 rounded shadow-sm">
                                                    {t.label}
                                                </span>
                                            </div>
                                        ))}

                                        {/* Video Controls */}
                                        <div className={`absolute bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-black/90 via-black/60 to-transparent transition-opacity duration-300 flex items-center gap-5 ${isExporting ? 'opacity-0 pointer-events-none' : 'opacity-0 group-hover:opacity-100'}`}>
                                            <button onClick={togglePlay} className="h-10 w-10 flex items-center justify-center bg-white/10 hover:bg-white/20 rounded-full backdrop-blur-md text-white transition">
                                                {isPlaying ? <Icon name="pause" size={20} className="fill-current" /> : <Icon name="play" size={20} className="fill-current ml-0.5" />}
                                            </button>
                                            <div className="flex-1 flex flex-col gap-1.5">
                                                <input type="range" min="0" max={duration || 100} value={currentTime} 
                                                    onChange={(e) => { const t = Number(e.target.value); videoRef.current.currentTime = t; setCurrentTime(t); }}
                                                    className="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer accent-emerald-500"
                                                />
                                                <div className="flex justify-between text-[10px] font-medium font-mono text-slate-300">
                                                    <span>{formatTime(currentTime)}</span>
                                                    <span>{formatTime(duration)}</span>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Export Overlay */}
                                        {isExporting && (
                                            <div className="absolute inset-0 bg-black/90 backdrop-blur-sm flex flex-col items-center justify-center z-50">
                                                <div className="text-center space-y-6 animate-enter">
                                                    <div className="relative">
                                                        <div className="absolute inset-0 bg-emerald-500 blur-xl opacity-20 rounded-full"></div>
                                                        <Icon name="film" size={64} className="text-emerald-500 relative z-10 animate-pulse mx-auto" />
                                                    </div>
                                                    <div>
                                                        <h2 className="text-2xl font-bold text-white mb-2">Exporting Highlight Reel</h2>
                                                        <p className="text-slate-400">Rendering 1080p WebM â€¢ Adding Transitions</p>
                                                    </div>
                                                    <div className="w-64 h-1.5 bg-slate-800 rounded-full overflow-hidden mx-auto">
                                                        <div className="h-full bg-emerald-500 transition-all duration-300 ease-out" style={{ width: `${progress}%` }}></div>
                                                    </div>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Helper Hint */}
                                    {triggers.length === 0 && (
                                        <div className="absolute top-8 bg-black/60 backdrop-blur-md border border-white/10 text-slate-200 px-5 py-3 rounded-full shadow-2xl flex items-center gap-3 animate-enter pointer-events-none">
                                            <div className="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
                                            <p className="text-sm font-medium">Pause video on event &rarr; Draw box to create trigger</p>
                                        </div>
                                    )}
                                </>
                            )}
                        </div>

                        {/* RIGHT: Sidebar */}
                        <div className="w-80 bg-slate-900/90 backdrop-blur-xl border-l border-slate-800 flex flex-col shrink-0 z-10">
                            
                            {/* Panel: Settings */}
                            <div className="p-5 border-b border-slate-800">
                                <div className="flex items-center gap-2 mb-4 text-slate-100">
                                    <Icon name="sliders" size={16} className="text-emerald-400" />
                                    <h2 className="text-xs font-bold uppercase tracking-widest">Configuration</h2>
                                </div>
                                <div className="space-y-5">
                                    <div>
                                        <div className="flex justify-between text-xs font-medium text-slate-400 mb-2">
                                            <span>Scan Speed</span><span className="text-emerald-400">{scanSpeed}x</span>
                                        </div>
                                        <input type="range" min="1" max="8" step="1" value={scanSpeed} onChange={(e) => setScanSpeed(Number(e.target.value))} className="w-full" />
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-xs font-medium text-slate-400 mb-2">
                                            <span>Pre-roll Capture</span><span className="text-emerald-400">{preRoll}s</span>
                                        </div>
                                        <input type="range" min="0" max="30" step="1" value={preRoll} onChange={(e) => setPreRoll(Number(e.target.value))} className="w-full" />
                                    </div>
                                    <div>
                                        <div className="flex justify-between text-xs font-medium text-slate-400 mb-2">
                                            <span>Clip Duration</span><span className="text-emerald-400">{clipDuration}s</span>
                                        </div>
                                        <input type="range" min="5" max="60" step="1" value={clipDuration} onChange={(e) => setClipDuration(Number(e.target.value))} className="w-full" />
                                    </div>
                                </div>
                            </div>

                            {/* Panel: Triggers */}
                            <div className="p-5 border-b border-slate-800 bg-slate-900/50">
                                <div className="flex items-center justify-between mb-3">
                                    <div className="flex items-center gap-2 text-slate-100">
                                        <Icon name="scan-line" size={16} className="text-emerald-400" />
                                        <h2 className="text-xs font-bold uppercase tracking-widest">Triggers</h2>
                                    </div>
                                    <span className="text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-400">{triggers.length}</span>
                                </div>
                                <div className="space-y-2 max-h-32 overflow-y-auto custom-scrollbar pr-1">
                                    {triggers.length === 0 ? <div className="text-center py-4 text-slate-600 text-xs italic">No triggers defined yet.</div> : 
                                    triggers.map(t => (
                                        <div key={t.id} className="flex items-center justify-between bg-slate-800/50 p-2.5 rounded-lg border border-slate-700/50 hover:border-slate-600 transition group">
                                            <div className="flex items-center gap-3">
                                                <div className="w-3 h-3 rounded-full shadow-sm ring-1 ring-white/10" style={{ backgroundColor: rgbToHex(t.color) }}></div>
                                                <span className="text-sm font-medium text-slate-300">{t.label}</span>
                                            </div>
                                            <button onClick={() => setTriggers(triggers.filter(tr => tr.id !== t.id))} className="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={14} /></button>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Panel: Highlights */}
                            <div className="flex-1 flex flex-col overflow-hidden bg-slate-950/30">
                                <div className="p-5 border-b border-slate-800 flex items-center justify-between bg-slate-900/80">
                                    <div className="flex items-center gap-2 text-slate-100">
                                        <Icon name="clapperboard" size={16} className="text-emerald-400" />
                                        <h2 className="text-xs font-bold uppercase tracking-widest">Highlights</h2>
                                    </div>
                                    {highlights.length > 0 && (
                                        <button onClick={exportHighlights} disabled={isExporting} 
                                            className="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-md text-[10px] font-bold uppercase tracking-wider transition shadow-lg shadow-indigo-900/50 disabled:opacity-50 disabled:cursor-not-allowed">
                                            {isExporting ? <div className="w-3 h-3 border-2 border-white/50 border-t-white rounded-full animate-spin"></div> : <Icon name="download" size={12} />}
                                            Export
                                        </button>
                                    )}
                                </div>
                                <div className="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar">
                                    {highlights.length === 0 ? 
                                        <div className="flex flex-col items-center justify-center h-full text-slate-600 opacity-50 space-y-3">
                                            <Icon name="history" size={40} strokeWidth={1.5} />
                                            <p className="text-xs font-medium">Timeline empty</p>
                                        </div> 
                                    : 
                                    highlights.map((h, i) => (
                                        <div key={i} className="group relative w-full flex items-center gap-3 p-2 bg-slate-800/40 hover:bg-slate-800 border border-slate-800 hover:border-slate-600 rounded-xl transition-all duration-200 cursor-pointer overflow-hidden">
                                            {/* Click area to jump */}
                                            <div className="flex-1 flex items-center gap-3" onClick={() => jumpToTime(h.time)}>
                                                <div className="relative w-20 h-14 bg-black rounded-lg overflow-hidden shrink-0 border border-slate-700/50 shadow-sm">
                                                    {h.thumbnail && <img src={h.thumbnail} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition" alt="thumb"/>}
                                                    <div className="absolute inset-0 flex items-center justify-center"><Icon name="play-circle" size={20} className="text-white opacity-0 group-hover:opacity-100 transition-all scale-75 group-hover:scale-100 drop-shadow-md" /></div>
                                                </div>
                                                <div className="flex flex-col gap-1 min-w-0">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-[10px] font-bold px-1.5 py-0.5 rounded shadow-sm border border-emerald-500/30 bg-emerald-500/20 text-emerald-300">
                                                            {h.type}
                                                        </span>
                                                        <span className="text-[10px] font-mono text-slate-500">@{formatTime(h.eventTime)}</span>
                                                    </div>
                                                    <p className="text-[10px] text-slate-400 line-clamp-1">Starts: <span className="font-mono text-slate-300">{formatTime(h.time)}</span></p>
                                                </div>
                                            </div>
                                            
                                            {/* Delete Button */}
                                            <button onClick={(e) => { e.stopPropagation(); deleteHighlight(i); }} 
                                                className="absolute right-2 p-2 rounded-lg bg-slate-950 text-slate-500 hover:text-red-400 hover:bg-red-500/10 opacity-0 group-hover:opacity-100 transition-all transform translate-x-2 group-hover:translate-x-0 shadow-lg">
                                                <Icon name="trash-2" size={16} />
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Modal: New Trigger */}
                        {showTriggerModal && (
                            <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/80 backdrop-blur-sm p-4 animate-enter">
                                <div className="bg-slate-900 border border-slate-700 p-6 rounded-2xl shadow-2xl w-full max-w-sm relative overflow-hidden">
                                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 to-cyan-500"></div>
                                    <h3 className="text-lg font-bold mb-6 flex items-center gap-2 text-white">
                                        <Icon name="scan-search" size={24} className="text-emerald-400" /> 
                                        New Event Trigger
                                    </h3>
                                    
                                    <div className="mb-6 space-y-2">
                                        <label className="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Detected Color</label>
                                        <div className="flex items-center gap-3 p-3 bg-slate-950 rounded-xl border border-slate-800">
                                            <div className="w-10 h-10 rounded-lg shadow-sm border border-slate-700" style={{ backgroundColor: tempTriggerColor ? rgbToHex(tempTriggerColor) : '#000' }} />
                                            <div className="flex flex-col">
                                                <span className="font-mono text-sm text-slate-300">{tempTriggerColor ? rgbToHex(tempTriggerColor) : '...'}</span>
                                                <span className="text-[10px] text-slate-500">Matches this pixel color</span>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mb-8">
                                        <button onClick={() => saveTrigger('Highlight Point')} 
                                            className="w-full py-3 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white rounded-lg text-sm font-bold transition shadow-lg shadow-emerald-500/20 border border-white/10 flex items-center justify-center gap-2">
                                            <Icon name="check" size={16} />
                                            Save as Highlight Point
                                        </button>
                                    </div>
                                    
                                    <button onClick={() => { setShowTriggerModal(false); setCurrentRect(null); }} className="w-full py-3 text-sm font-medium text-slate-400 hover:text-white transition rounded-lg hover:bg-slate-800">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
